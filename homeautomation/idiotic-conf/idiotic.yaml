version: 1
global: {}
cluster:
  listen: '0.0.0.0'
  rpc_port: 28301
  port: 28300
nodes:
  idiotic:
    host: 10.2.0.23
  scootaloo:
    host: 10.1.253.240
modules:
  nest:
    oauth_token: {{ salt['pillar.get']('idiotic:nest:token') }}
  smartthings:
    oauth_token: {{ salt['pillar.get']('idiotic:smartthings:token') }}
    endpoints_uri: https://graph.api.smartthings.com/api/smartapps/endpoints
    location: Home
  zoneminder:
    database: {{ salt['pillar.get']('idiotic:zoneminder:url') }}
    update_interval: 5
blocks:
  zero:
    type: value.float
    initial: 0.0

  sun:
    type: suntime.sun
    location:
      latitude: {{ salt['pillar.get']('idiotic:location:latitude') }}
      longitude: {{ salt['pillar.get']('idiotic:location:longitude') }}
      timezone: US/Eastern

  zone_driveway:
    type: zoneminder.zone
    monitor: Driveway
    zone: Driveway

  zone_sidewalk:
    type: zoneminder.zone
    monitor: Driveway
    zone: Front Sidewalk

  driveway_occupied:
    type: occupancy.occupancy
    inputs:
      motion_driveway: zone_driveway
      motion_sidewalk: zone_sidewalk

  front_light_power:
    type: logic.and
    inputs:
      a: driveway_occupied
      b: sun.down
    input_to:
      - front_light.power

  zone_foscam:
    type: zoneminder.zone
    monitor: Foscam
    zone: All

  dining_room_occupied:
    type: occupancy.occupancy
    decay: .98
    threshold: .35
    inputs:
      motion_foscam: zone_foscam
    input_to:
      - dining_table_1.power
      - dining_table_2.power
      - dining_table_3.power
      - dining_room_lamp.power

  downstairs_scale:
    type: value.str
    initial: F

  downstairs_scale_correct:
    type: logic.equal
    inputs:
      a: downstairs_scale
      b: downstairs_heat.temperature_scale

  downstairs_scale_wrong:
    type: logic.not
    inputs:
      a: downstairs_scale_correct

  force_downstairs_scale:
    type: logic.output_if
    inputs:
      condition: downstairs_scale_wrong
      value: downstairs_scale
    input_to:
      - downstairs_heat.temperature_scale

  downstairs_setpoint:
    type: value.float
    initial: 67

  downstairs_setpoint_correct:
    type: logic.equal
    inputs:
      a: downstairs_setpoint
      b: downstairs_heat.target

  downstairs_setpoint_wrong:
    type: logic.not
    inputs:
      a: downstairs_setpoint_correct

  force_downstairs_setpoint:
    type: logic.output_if
    inputs:
      condition: downstairs_setpoint_wrong
      value: downstairs_setpoint
    input_to:
      - downstairs_heat.target

  downstairs_heat:
    type: nest.thermostat
    label: Living Room
    kind: thermostat

  upstairs_ac:
    type: nest.thermostat
    label: Upstairs
    kind: thermostat

  average_temp:
    type: math.average
    initial: 0
    default: 0
    inputs:
      downstairs: downstairs_heat.temperature
      upstairs: upstairs_ac.temperature

  average_humidity:
    type: math.average
    initial: 0
    default: 0
    inputs:
      downstairs: downstairs_heat.temperature
      upstairs: upstairs_ac.temperature

  living_room_lamp:
    type: smartthings.switch
    label: Living Room Lamp
    id: c32ee798-2e01-4d4b-ae54-acd42c196f20

#  living_room_front:
#    type: smartthings.switch
#    label: Living Room Front

  living_room_corner:
    type: smartthings.switch
    label: Living Room Corner

  dining_room_lamp:
    type: smartthings.switch
    label: Dining Room Lamp
    id: 96c9b9ff-2a93-4d8b-8477-58db1a256056

  dining_table_1:
    type: smartthings.switch
    label: Dining Table 1
    id: bc658d54-abfc-464d-8b60-3bf5770fc25b

  dining_table_2:
    type: smartthings.switch
    label: Dining Table 2
    id: cc639f14-8e6e-46e1-8085-53de8041a0cf

  dining_table_3:
    type: smartthings.switch
    label: Dining Table 3
    id: 103d5bbd-7fb7-41f7-8c05-bf9fbffc704c

  dylan_fan_1:
    type: smartthings.switch
    label: Dylan's Fan 1

  dylan_fan_2:
    type: smartthings.switch
    label: Dylan's Fan 2

  dylan_fan_3:
    type: smartthings.switch
    label: Dylan's Fan 3

  marks_room_1:
    type: smartthings.switch
    label: Mark's Room 1

  marks_room_2:
    type: smartthings.switch
    label: Mark's Room 2

  front_light:
    type: smartthings.switch
    label: Front Light
    id: 279734bc-8c5c-4b8e-9355-09abb0b9f1c2

  teakettle:
    type: teapot.teapot
    address: 'https://api.particle.io'
    path: '/v1/devices/'
    access_token: {{ salt['pillar.get']('idiotic:teapot:access_token') }}
    device_id: '210035001447343338333633'

  front_lights:
    type: http.http
    method: post
    url: http://10.1.254.21//put_saved_animation/{animation}

  motion:
    type: gpio.RPiGPIO
    device: MotionSensor
    options:
      pin: 4
    require:
      - host.node_name: scootaloo
    input_to:
      - living_room_corner.power
